---
title: "데이터폼 용어 및 인증 흐름 이해하기"
description: ""
coverImage: "/assets/img/2024-05-15-UnderstandingDataformTerminologiesAndAuthenticationFlow_0.png"
date: 2024-05-15 15:52
ogImage: 
  url: /assets/img/2024-05-15-UnderstandingDataformTerminologiesAndAuthenticationFlow_0.png
tag: Tech
originalTitle: "Understanding Dataform Terminologies And Authentication Flow"
link: "https://medium.com/towards-data-science/understanding-dataform-terminologies-and-authentication-flow-aa98c2fbcdfb"
---


## MLOPS: 데이터 파이프라인 오케스트레이션

![이미지](/assets/img/2024-05-15-UnderstandingDataformTerminologiesAndAuthenticationFlow_0.png)

Dataform은 팀이 복잡한 SQL 기반 데이터 파이프라인을 개발하고 운영할 수 있게 해주는 GCP 서비스의 일환으로 추가된 새로운 서비스입니다. Dataform은 소프트웨어 엔지니어링의 최고 관행인 테스팅, 환경, 버전 제어, 종속성 관리, 오케스트레이션 및 자동 문서화를 데이터 파이프라인에 적용할 수 있습니다. 이는 GCP 내에서 서버리스, SQL 워크플로 오케스트레이션의 주요 요소입니다. 위의 이미지에서 볼 수 있듯이 Dataform은 원시 데이터를 가져와 소프트웨어 엔지니어링의 최고 관행을 적용하여 구조화가 잘 된 데이터를 생산합니다.

이 게시물의 영감은 저희 프로젝트 중 하나인 기존 Dataform의 웹 UI에서 GCP BigQuery로의 마이그레이션 중 발생했습니다. 마이그레이션 중, 릴리스 구성, 워크플로 구성 및 개발 워크스페이스와 같은 용어들이 정말 혼란스럽고 납득하기 어려웠습니다. 이것이 GCP Dataform에서 사용되는 일부 새로운 용어를 설명하는 게시물을 작성하게 된 동기가 되었습니다. 또한 GCP에서 단일 저장소 다중 환경 Dataform 작업의 기본 흐름을 강조할 것입니다. Dataform을 설정하는 다양한 방법이 있으므로 구글의 모베스트 관행을 확인해보세요.



이것은 데이터폼의 기초와 설정을 다룬 2부작 시리즈 중 첫 번째 부분입니다. 제2부에서는 데이터폼을 프로비저닝할 때 최소 액세스 제어를 구현하는 방법을 보여드리겠습니다. 이에 대한 미리보기를 원하신다면 저장소를 확인해보세요.

# 용어

데이터폼에서의 구현은 GitHub 워크플로우와 유사합니다. 두 가지 간 유사성을 대조하고 이해하기 쉽도록 비유를 만들어보겠습니다. 데이터폼을 로컬 GitHub 저장소로 상상하는 것은 쉽습니다. 데이터폼을 설정할 때 로컬 GitHub이 원격 소스와 함께 연결되는 것과 유사한 방식으로 원격 저장소가 구성되도록 요청될 것입니다. 이 시나리오 설정을 염두에 두고 빠르게 데이터폼 용어를 살펴보겠습니다.

## 개발 워크스페이스



로컬 GitHub 브랜치와 유사한 개념입니다. GitHub의 main에서 브랜치를 만드는 것과 유사하게, 새로운 Dataform 개발 워크스페이스는 main Dataform 저장소 코드의 편집 가능한 사본을 체크아웃합니다. 개발 워크스페이스는 GitHub 브랜치처럼 서로 독립적입니다. 코드 개발과 실험은 개발 워크스페이스 내에서 진행되며, 코드가 커밋되고 푸시되면 개발 워크스페이스와 유사한 이름의 원격 브랜치가 생성됩니다. 개발 워크스페이스로 코드를 체크아웃하는 GitHub 저장소는 구성 가능하며, main 브랜치나 원격 저장소의 다른 브랜치 중 어디서든 가능합니다.

## 릴리스 구성

Dataform은 데이터 변환과 로직을 위해 .sqlx 스크립트와 Javascript .js를 혼합하여 사용합니다. 결과적으로 코드베이스의 표준적이고 재현 가능한 파이프라인 표현을 얻기 위해 먼저 코드베이스의 컴파일을 생성하고 스크립트가 데이터로 구체화될 수 있는지 확인합니다. 릴리스 구성은 이 컴파일이 수행되는 자동화된 프로세스입니다. 구성된 시간에, Dataform은 원격 main 저장소의 코드를 체크아웃하고 JSON 구성 파일로 컴파일합니다. 코드를 체크아웃하고 컴파일을 생성하는 과정이 릴리스 구성이 다루는 내용입니다.

## Workflow 구성



릴리즈 구성의 출력물은 .json 구성 파일입니다. 워크플로 구성은 구성 파일을 언제 실행할지, 누가 실행해야 하는지 및 어느 환경에 구성 파일 출력물이 표시되거나 작성될지를 결정합니다.

워크플로 구성은 릴리즈 구성의 출력물이 필요하기 때문에, 릴리즈 구성보다 이후에 실행되도록하는 것이 합리적입니다. 그 이유는 릴리즈 구성이 먼저 원격 저장소에 인증해야 하고(때로 실패할 수 있음), 코드를 체크아웃하고 컴파일해야 하기 때문입니다. 이러한 단계는 몇 초 안에 발생하지만 네트워크 연결 장애의 경우 더 많은 시간이 소요될 수 있습니다. 워크플로 구성은 릴리즈 구성에 의해 생성된 .json 컴파일 파일이 필요하기 때문에, 릴리즈 구성보다 나중에 예약하는 것이 의미가 있습니다. 동시에 예약하면 워크플로 구성이 이전 컴파일을 사용할 수 있으므로, 최신 변경 사항이 바로 BQ 테이블에 반영되지 않을 수 있습니다. 다음 워크플로 구성이 실행될 때까지 또는 BQ 테이블에 반영되지 않습니다.

## 환경

<img src="/assets/img/2024-05-15-UnderstandingDataformTerminologiesAndAuthenticationFlow_1.png" />



Dataform의 기능 중 하나는 코드를 개발, 스테이징 및 프로덕션과 같은 다른 환경으로 변환할 수 있는 기능입니다. 여러 환경에서 작업하는 것은 Dataform의 설정 방법에 어려움을 가져올 수 있습니다. 여러 환경에서 데이터 형성이 더 좋을까요? 단일 환경에서만 형성해야 할까요? Google은 Dataform 최상의 실천법 섹션에서 이러한 Trade-offs에 대해 논의했습니다. 이 게시물은 단일 리포지토리로 스테이징 및 프로덕션 환경에 Dataform을 설정하는 방법을 보여줍니다.

환경들은 각각 사용자 지정 서비스 계정이 있는 GCP 프로젝트로 설정됩니다. Dataform은 스테이징 환경/프로젝트에만 생성되며 많은 변경 사항을 가지고 있기 때문에 스테이징(또는 비 프로덕션) 환경에서 실험하는 것이 좋습니다. 또한, 개발 코드가 나타나는 환경으로 스테이징 환경이 선택됩니다. 이는 개발 워크스페이스에서 생성된 데이터셋과 테이블이 스테이징 환경 안에서 나타나게 됨을 의미합니다.

개발이 완료되면 코드가 커밋되고 원격 리포지토리에 푸시됩니다. 그 후, 리뷰를 거친 후 PR을 올릴 수 있으며 메인 리포지토리에 병합됩니다. 예약된 워크플로에서 릴리스 및 워크플로 구성이 실행됩니다. Dataform은 메인 브랜치에서 코드를 컴파일하고 프로덕션 환경 내에서 실행되도록 구성되어 있습니다. 따라서, 리뷰를 거친 코드만이 프로덕션으로 이동하고 개발 코드는 스테이징 환경에 남아 있습니다.

요약하면, 위 Dataform 아키텍처 플로우에서 개발 워크스페이스에서 개발된 코드는 스테이징 환경에 나타내거나 원격 GitHub으로 푸시되어 피어 리뷰를 거치고 메인 브랜치에 병합됩니다. 릴리스 구성은 주요 브랜치에서 코드를 컴파일하고 워크플로 구성은 컴파일된 코드를 가져와 프로덕션 환경에 데이터를 나타냅니다. 따라서, GitHub 메인 브랜치에 있는 리뷰된 코드만이 프로덕션 환경에 나타납니다.



# 인증

데이터폼의 인증은 특히 여러 환경을 설정할 때 복잡하고 까다로울 수 있습니다. 스테이징 및 프로덕션 환경의 예제를 사용하여 이를 어떻게 수행하는지 설명하겠습니다. 어디에 인증이 필요하고 그 방법에 대해 알아봅시다.

![그림](/assets/img/2024-05-15-UnderstandingDataformTerminologiesAndAuthenticationFlow_2.png)

위의 도표는 인증이 필요한 위치와 리소스에 대해 추적할 수 있는 간단한 데이터폼 워크플로우를 보여줍니다. 이 흐름은 개발 워크스페이스에서 데이터폼이 실행되고 일정에 따라 실행될 때(릴리스 및 워크플로 구성) 무엇이 발생하는지를 기록합니다.



기계 사용자

기계 사용자에 대해 이야기해봅시다. Dataform은 원격 저장소에 저장된 코드를 확인할 때 GitHub에 액세스하기 위한 자격 증명이 필요합니다. 개별 자격 증명을 사용할 수 있지만, 최선의 방법은 조직 내에서 기계 사용자를 사용하는 것입니다. 이러한 방법을 통해 Dataform 파이프라인 조종은 개별 신원과 독립적이며 그들의 이탈에 영향받지 않습니다. 기계 사용자를 설정하는 것은 여기에 자세히 설명된대로 개인에 속하지 않은 신원을 사용하여 GitHub 계정을 설정하는 것을 의미합니다. Dataform의 경우, 기계 사용자 계정을 위해 개인 액세스 토큰(PAT)이 생성되고 GCP 시크릿 매니저에 비밀로 저장됩니다. 또한 기계 사용자는 Dataform 원격 저장소에 읽기 및 쓰기 액세스 권한을 가진 외부 공동 작업자로 추가되어야 합니다. 나중에 테라폼 코드에서 Dataform이 비밀에 액세스할 수 있도록 구성되는 방법을 살펴볼 것입니다. 사용자가 기계 사용자 대신 자신의 신원을 사용하기로 결정할 경우, 여기에 자세히 설명된대로 토큰을 생성해야 합니다.

GitHub 인증 흐름

![GitHub 인증 흐름](/assets/img/2024-05-15-UnderstandingDataformTerminologiesAndAuthenticationFlow_3.png)



데이터폼은 구현을 위해 기본 서비스 계정을 사용합니다. 따라서 데이터폼 작업을 수행할 때 기본 서비스 계정부터 시작됩니다. 기계 사용자를 설정했다고 가정하고, 해당 사용자를 원격 저장소의 공동 작업자로 추가하고 해당 사용자 PAT를 GCP 시크릿 매니저에 비밀로 추가해야 합니다. GitHub에 인증하기 위해 기본 서비스 계정은 시크릿 매니저로부터 비밀을 추출해야 합니다. 기본 서비스 계정은 비밀을 액세스하기 위해 secretAccessor 역할이 필요합니다. 비밀에 액세스한 후, 기본 서비스 계정은 이제 기계 사용자를 표현할 수 있으며, 기계 사용자가 원격 Git 리포지토리의 공동 작업자로 추가되었기 때문에 기본 서비스 계정은 이제 해당 원격 GitHub 리포지토리에 공동 작업자로서 액세스할 수 있습니다. 이 흐름은 GitHub 인증 워크플로우 그림에 표시되어 있습니다.

개발 워크스페이스 인증

개발 워크스페이스에서 실행이 트리거되면, 기본 서비스 계정은 스테이징 환경 사용자 지정 서비스 계정으로 교체하여 스테이징 환경 내부에서 결과를 표시합니다. 스테이징 환경 사용자 지정 서비스 계정을 나타내기 위해 기본 서비스 계정이 필요한 것은 스테이징 서비스 계정에 대한 iam.serviceAccountTokenCreator 역할입니다. 이를 통해 기본 서비스 계정이 스테이징 사용자 지정 서비스 계정을 나타내기 위해 사용되는 기계 사용자를 표현하는 데 사용되는 PAT과 유사한 짧은 수명의 토큰을 생성할 수 있게 되며, 이를 통해 나타낼 수 있습니다. 따라서 스테이징 사용자 지정 서비스 계정은 BigQuery 테이블에 쓰기 권한이 모두 부여되고, 기본 서비스 계정은 스테이징 사용자 지정 서비스 계정을 나타낼 때 이러한 권한을 상속받을 수 있습니다.

워크플로 구성 인증



리포지토리를 확인한 후 릴리스 구성은 컴파일된 config .json 파일을 생성합니다. 이 파일에서 workflow 구성은 데이터를 생성합니다. 프로덕션 BQ 테이블에 데이터를 쓰기 위해 기본 서비스 계정은 프로덕션 사용자 정의 서비스 계정에 대해 iam.serviceAccountTokenCreator 역할이 필요합니다. 스테이징 사용자 정의 서비스 계정을 위해 수행한 것과 유사하게, 프로덕션 서비스 계정은 프로덕션 환경 BQ 테이블에 쓰기 위해 필요한 모든 권한을 부여받고, 기본 서비스 계정은 이 서비스 계정을 표시할 때 모든 권한을 상속합니다.

요약

요약하자면, 기본 서비스 계정이 주요 인물입니다. 기계 사용자를 표시할 때 기계 사용자 PAT를 사용하여 GitHub에 공동 작업자로 인증합니다. 또한 serviceAccountTokenCreator 역할로 생성된 단기 토큰을 사용하여 각각의 사용자 정의 서비스 계정을 표시하여 스테이징 및 프로덕션 환경에 인증합니다. 이해한 내용을 바탕으로 GCP 내에서 Terraform을 사용하여 Dataform을 프로비저닝할 시간입니다. 이에 대한 자세한 내용은 블로그의 Part 2를 기대하거나 코드를 확인하세요.

이미지 출처: 본 게시물의 모든 이미지는 저자가 제작했습니다.



## 참고 자료

- [Dataform 소개 페이지](https://cloud.google.com/dataform?hl=ko)
- [Dataform 이전 가이드 문서](https://cloud.google.com/dataform/docs/migration)
- [Dataform 모범 사례 문서](https://cloud.google.com/dataform/docs/best-practices)